(()=>{"use strict";var e={7153:(e,t,n)=>{e.exports=n.p+"assets/Start.8240.mp3"},6339:(e,t,n)=>{e.exports=n.p+"assets/selectSongItem.7cc8.mp3"}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var c=t[o]={exports:{}};return e[o](c,c.exports,n),c.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var o=t.getElementsByTagName("script");o.length&&(e=o[o.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e+"../"})(),(()=>{const e={ez:0,hd:1,in:2,at:3};var t=n(6339);function o(t,n,o,{level:i,onClick:c}){const a=document.createElement("div");a.classList.add("songItemContainer");const s=function(e,t){const n=document.createElement("div");return n.classList.add("songItem"),n.setAttribute("data-artist",e.artist),n.setAttribute("data-codename",t),n.innerText=e.name,n}(n,o),r=function(e,t="ez"){const n=document.createElement("div");return n.classList.add("level"),o(t),{element:n,switchLevel:o};function o(t){n.classList.remove("ez","hd","in","at"),n.classList.add(t),n.setAttribute("data-level",Math.floor(e[t+"Ranking"]||e.ezRanking||e.hdRanking||e.inRanking||e.atRanking||0))}}(n,i);return a.appendChild(s),a.appendChild(r.element),a.addEventListener("click",(()=>c(t))),{element:a,songMeta:n,codename:o,select:()=>{s.classList.add("selected"),a.classList.add("selected");for(const t in e)document.querySelector(`div.levelItem.${t}`).classList.remove("disabled"),null==n["chart"+t.toUpperCase()]&&(document.querySelector(`div.levelItem.${t}`).classList.add("disabled"),document.querySelector(`div.levelItem.${t}`).classList.remove("selected")),document.querySelector(`div.levelItem.${t}`).setAttribute("data-level",Math.floor(n[t+"Ranking"]||n.ezRanking||n.hdRanking||n.inRanking||n.atRanking||0))},unSelect:()=>{s.classList.remove("selected"),a.classList.remove("selected")},switchLevel:r.switchLevel}}var i=n(7153);const c=function({defaultLevel:n="ez"}){const i=document.createElement("div");i.id="songList",i.classList.add("songList");const c=[];let a,s=n;return{element:i,items:c,createSong:function(e,t,n){const a=new o(c.length,t,n,{onClick:r,level:s});i.appendChild(a.element),c[e]=a},switchSong:r,switchLevel:l,setOrder:function(e){switch(e){case"level":d(((e,t)=>e.songMeta[`${s}Ranking`]<t.songMeta[`${s}Ranking`]?1:-1));break;case"name":d(((e,t)=>e.songMeta.name>t.songMeta.name?1:-1));break;default:c.forEach((({element:e})=>e.style.order=""))}}};function r(n){if(n===a)return;document.querySelector("#loadingBar").classList.remove("hidden"),fetch(t).then((e=>e.arrayBuffer())).then((e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,(function(e){var n=t.createBufferSource();n.buffer=e,n.loop=!1,n.connect(t.destination),n.start(0)}))})),void 0!==a&&c[a].unSelect(),i.classList.selected||i.classList.add("selected"),c[n].select(),console.log("Song",n,"Selected");const{songMeta:o,codename:s}=c[n];for(var r=window.levelSelected||["ez"];null==o["chart"+r[0].toUpperCase()];){var d=e[r[0]]+1;4==d&&(d=0);var u=Object.keys(e)[d];console.log("Chart of level",r[0],"is NULL! Switching to next level: ",u),document.querySelector(`div.levelItem.${r[0]}`).classList.add("disabled"),document.querySelector(`div.levelItem.${r[0]}`).classList.remove("selected"),l(u.match(u)),document.querySelector(`div.levelItem.${u}`).classList.add("selected"),document.querySelectorAll("#songList > div.songItemContainer.selected > div.level").forEach((e=>{e.classList.remove(r[0]),e.classList.add(u)})),r=[u]}fetch(`https://charts.phicommunity.com.cn/${s}/${o.illustration}`).then((e=>e.blob())).then((e=>{const t=URL.createObjectURL(e);document.children[0].setAttribute("style",`--background: url(${t});`),document.querySelector("img.illustration").src=t})).catch((e=>{console.err("获取曲绘失败!",`url: https://charts.phicommunity.com.cn/${s}/${o.illustration}`,e)})),fetch(`https://charts.phicommunity.com.cn/${s}/${o.musicFile}`).then((e=>e.blob())).then((e=>{const t=URL.createObjectURL(e);try{window.playSongXHRObj.abort()}catch(e){}fetch(t).then((e=>e.arrayBuffer())).then((e=>{const t=window.slicesAudioContext.createGain();window.slicesAudioContext.decodeAudioData(e,(function(e){try{window.sliceAudioContextSource.stop()}catch(e){}window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),t.connect(window.slicesAudioContext.destination),window.sliceAudioContextSource.start(0,o.sliceAudioStart),t.gain.setValueAtTime(.01,window.slicesAudioContext.currentTime),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1),clearInterval(window.sliceAudioInterval),window.sliceAudioInterval=setInterval((()=>{t.gain.linearRampToValueAtTime(.01,window.slicesAudioContext.currentTime+1),setTimeout((()=>{window.sliceAudioContextSource.stop(),window.sliceAudioContextSource=window.slicesAudioContext.createBufferSource(),window.sliceAudioContextSource.buffer=e,window.sliceAudioContextSource.connect(t),window.sliceAudioContextSource.start(0,o.sliceAudioStart),t.gain.linearRampToValueAtTime(1,window.slicesAudioContext.currentTime+1)}),500)}),15e3)})),document.querySelector("#loadingBar").classList.add("hidden")}))})).catch((e=>{console.err("获取歌曲失败!",`url: https://charts.phicommunity.com.cn/${s}/${o.musicFile}`,e)})),a=n}function l(e){s!==e&&(window.levelSelected=e,c.forEach((({switchLevel:t})=>t(e))),s=e)}function d(e){[...c].sort(((t,n)=>e(t,n))).forEach((({element:e},t)=>{e.style.order=t}))}}({defaultLevel:"ez"});function a(e){const t=e;try{document.querySelector("div.levelItem.selected").classList.add("fadeOut")}catch(t){}setTimeout((()=>{try{document.querySelector("div.levelItem.selected").classList.remove("selected")}catch(e){}t.target.classList.add("fadeIn"),t.target.classList.add("selected")}),300);const n=t.target.classList.toString();c.switchLevel(n.match(/ez|hd|in|at/));const o=document.querySelectorAll("div.levelItem.fadeIn");for(let e=0;e<o.length;e++)o[e].classList.remove("fadeIn");const i=document.querySelectorAll("div.levelItem.fadeOut");for(let e=0;e<o.length;e++)i[e].classList.remove("fadeOut")}window.addEventListener("DOMContentLoaded",(()=>{let e=document.createElement("iframe");e.src="../loadingScreen/index.html",e.classList.add("loadingEmbedFrame"),document.body.appendChild(e);const t=[["default","默认"],["level","难度"],["name","名称"]];document.querySelector("div.settingBtn").addEventListener("click",(()=>{location.href="../settings/index.html"})),document.querySelector("div#avatarBar").addEventListener("click",(e=>{var t=e.target;null==t.classList.toString().match("avatarBar")&&(t=e.target.parentElement),t.classList.toString().match("expand")?t.classList.remove("expand"):t.classList.add("expand")})),null!=window.localStorage.getItem("playerName")&&(console.log("Setting player name: ",window.localStorage.getItem("playerName")),document.querySelector("div#avatarBar").setAttribute("data-name",window.localStorage.getItem("playerName"))),null!=window.localStorage.getItem("playerAvatar")&&(console.log("Setting player avatar: ",window.localStorage.getItem("playerAvatar")),document.querySelector("div#avatarBar").children[0].setAttribute("style",'--avatar: url("'+window.localStorage.getItem("playerAvatar")+'");')),window.chapterName=new URLSearchParams(new URL(location.href).search).get("c"),fetch("https://api.github.com/repos/HanHan233/PhiCommunity-Charts-Repo/contents").then((e=>e.json())).then((n=>{window.songCodeNameList=new Array;for(let e=0;e<n.length;e++)null==n[e].name.match(/.github|README.md|CNAME|_headers/)&&window.songCodeNameList.push(n[e].name);window.songMetaList=new Array;for(let e=0;e<window.songCodeNameList.length;e++)fetch(encodeURI("https://charts.phicommunity.com.cn/"+window.songCodeNameList[e]+"/meta.json")).then((e=>e.json())).then((e=>{window.songMetaList.push(e)}));const o=setInterval((()=>{if(window.songMetaList.length==window.songCodeNameList.length){const n=c.element;document.getElementsByClassName("leftArea")[0].appendChild(n);for(let e=0;e<window.songMetaList.length;e++)c.createSong(e,window.songMetaList[e],window.songMetaList[e].codename);let i=0;document.querySelector("div.sortMode").innerText=t[0][1],document.querySelector("div.sortMode").addEventListener("click",(e=>{i=(i+1)%t.length,c.setOrder(t[i][0]),e.target.innerText=t[i][1]})),window.slicesAudioContext=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext),c.switchSong(0),e.remove(),document.querySelector("#rightArea").style.setProperty("--scale",Math.round(window.devicePixelRatio)/3.5),clearInterval(o)}}),100)})).catch((()=>{alert("曲目列表获取失败！")}))})),document.querySelectorAll("div.levelItem").forEach((e=>e.addEventListener("click",a))),document.querySelector("div.playBtn").addEventListener("click",(()=>{clearInterval(window.sliceAudioInterval);try{window.sliceAudioContextSource.stop()}catch(e){}document.querySelector("#readyToLoadOverlay").classList.add("go"),fetch(i).then((e=>e.arrayBuffer())).then((e=>{const t=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);t.decodeAudioData(e,(function(e){var n=t.createBufferSource();n.buffer=e,n.loop=!1,n.connect(t.destination),n.start(0)}))})),setTimeout((()=>{window.slicesAudioContext.close(),location.href="../whilePlaying/index.html?play="+document.querySelector("div.songItem.selected").getAttribute("data-codename")+"&l="+window.levelSelected}),2e3)}))})()})();